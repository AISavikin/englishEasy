{% extends 'base.html' %}
{% block title %}–ü—Ä–∞–≤–æ–ø–∏—Å–∞–Ω–∏–µ (Spelling){% endblock %}

{% block extra_style %}
    <style>
        /* –°—Ç–∏–ª–∏ –¥–ª—è –≤–≤–æ–¥–∞ –±—É–∫–≤ */
        .letter-input {
            width: 70px;
            height: 80px;
            border: 3px solid #dee2e6;
            border-radius: 10px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 0 10px;
            font-size: 28px;
            font-weight: bold;
            background-color: white;
            text-align: center;
            text-transform: uppercase;
            transition: all 0.3s;
        }

        .letter-input:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.25);
            outline: none;
        }

        .letter-input.correct {
            border-color: #198754;
            background-color: rgba(25, 135, 84, 0.1);
        }

        .letter-input.incorrect {
            border-color: #dc3545;
            background-color: rgba(220, 53, 69, 0.1);
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–ª–æ–≤–∞ */
        .word-container {
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 30px;
        }

        .russian-word {
            font-size: 2.5rem;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 40px;
            color: #2c3e50;
            text-align: center;
        }

        .inputs-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin: 30px 0;
            padding: 20px;
        }

        .progress-container {
            position: sticky;
            top: 0;
            background: white;
            z-index: 100;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        /* –ü–æ–¥—Å–∫–∞–∑–∫–∏ */
        .hint {
            font-size: 0.9rem;
            color: #6c757d;
            text-align: center;
            margin-top: 10px;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes shake {
            0%, 100% {
                transform: translateX(0);
            }
            25% {
                transform: translateX(-5px);
            }
            75% {
                transform: translateX(5px);
            }
        }

        .shake {
            animation: shake 0.3s ease-in-out;
        }

        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è */
        .exercise-title {
            font-size: 1.8rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .exercise-subtitle {
            color: #6c757d;
            font-size: 1.1rem;
            margin-bottom: 1.5rem;
        }

        /* –ü–æ–¥—Å–∫–∞–∑–∫–∞ —Å –∞–Ω–≥–ª–∏–π—Å–∫–∏–º —Å–ª–æ–≤–æ–º */
        .word-hint {
            font-size: 1.2rem;
            color: #6c757d;
            letter-spacing: 2px;
            margin-bottom: 20px;
            text-align: center;
        }

        .hint-letter {
            display: inline-block;
            width: 30px;
            text-align: center;
            border-bottom: 2px solid #6c757d;
            margin: 0 5px;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è —É—Å–ø–µ—Ö–∞ –∏ –Ω–µ—É–¥–∞—á–∏ */
        @keyframes confetti-fall {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        @keyframes success-particle {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--tx), var(--ty)) scale(0);
                opacity: 0;
            }
        }

        @keyframes sad-fall {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        @keyframes failure-drop {
            0% {
                transform: translateY(0);
                opacity: 1;
            }
            100% {
                transform: translateY(50px);
                opacity: 0;
            }
        }

        @keyframes success-pulse {
            0% {
                background-color: rgba(76, 175, 80, 0.1);
            }
            50% {
                background-color: rgba(76, 175, 80, 0.3);
            }
            100% {
                background-color: transparent;
            }
        }

        @keyframes failure-shake {
            0%, 100% {
                background-color: transparent;
            }
            25% {
                background-color: rgba(255, 68, 68, 0.1);
            }
            50% {
                background-color: rgba(255, 68, 68, 0.2);
            }
            75% {
                background-color: rgba(255, 68, 68, 0.1);
            }
        }

        .success-animation {
            animation: success-pulse 0.5s ease-in-out;
        }

        .failure-animation {
            animation: failure-shake 0.5s ease-in-out;
        }

        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª—è –≤–≤–æ–¥–∞ */
        .letter-input.correct {
            border-color: #198754;
            background-color: rgba(25, 135, 84, 0.1);
            box-shadow: 0 0 10px rgba(25, 135, 84, 0.3);
        }

        .letter-input.incorrect {
            border-color: #dc3545;
            background-color: rgba(220, 53, 69, 0.1);
            box-shadow: 0 0 10px rgba(220, 53, 69, 0.3);
        }
    </style>
{% endblock %}

{% block content %}
    <div class="container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è -->
        <div class="row mb-4">
            <div class="col">
                <div class="exercise-title">
                    {% if exercise.description %}
                        {{ exercise.description }}
                    {% else %}
                        –ü—Ä–∞–≤–æ–ø–∏—Å–∞–Ω–∏–µ (Spelling)
                    {% endif %}
                </div>
                <div class="exercise-subtitle">
                    –í–≤–µ–¥–∏—Ç–µ –∞–Ω–≥–ª–∏–π—Å–∫–æ–µ —Å–ª–æ–≤–æ –ø–æ –±—É–∫–≤–∞–º
                    {% if exercise.due_date %}
                        <span class="badge bg-warning ms-2">
                        –°—Ä–æ–∫: {{ exercise.due_date|date:"d.m.Y H:i" }}
                    </span>
                    {% endif %}
                </div>
            </div>
            <div class="col-auto">
                <div class="badge bg-primary fs-6">
                    {{ exercise.get_assignment_type_display }}
                </div>
            </div>
        </div>

        <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
        <div class="progress-container mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0">–ü—Ä–∞–≤–æ–ø–∏—Å–∞–Ω–∏–µ (Spelling)</h4>
                <div>
                    <span id="current-word" class="badge bg-primary fs-6">1</span> –∏–∑
                    <span id="total-words" class="badge bg-secondary fs-6">{{ pairs|length }}</span>
                </div>
            </div>
            <div class="progress mt-2" style="height: 8px;">
                <div id="exercise-progress" class="progress-bar" style="width: 0%"></div>
            </div>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è -->
        <div class="card shadow">
            <div class="card-body">
                <div id="word-container" class="word-container">
                    <!-- –†—É—Å—Å–∫–æ–µ —Å–ª–æ–≤–æ -->
                    <div id="current-russian" class="russian-word mb-4"></div>

                    <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —Å–ª–æ–≤–∞ -->
                    <div id="word-hint" class="word-hint mb-4"></div>

                    <!-- –ü–æ–ª—è –¥–ª—è –≤–≤–æ–¥–∞ –±—É–∫–≤ -->
                    <div class="hint">–í–≤–µ–¥–∏—Ç–µ –∞–Ω–≥–ª–∏–π—Å–∫–æ–µ —Å–ª–æ–≤–æ –ø–æ –±—É–∫–≤–∞–º:</div>
                    <div id="inputs-container" class="inputs-container mb-4"></div>

                    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç -->
                    <div id="result-message" class="alert d-none mb-4"></div>

                    <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                    <div class="mt-4">
                        <button id="check-btn" class="btn btn-primary btn-lg me-3">
                            <i class="bi bi-check-circle me-2"></i>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å
                        </button>
                        <button id="reset-btn" class="btn btn-outline-secondary btn-lg me-3">
                            <i class="bi bi-arrow-clockwise me-2"></i>–û—á–∏—Å—Ç–∏—Ç—å
                        </button>
                        <button id="show-hint-btn" class="btn btn-info btn-lg me-3">
                            <i class="bi bi-lightbulb me-2"></i>–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É
                        </button>
                        <button id="next-btn" class="btn btn-success btn-lg d-none">
                            <i class="bi bi-arrow-right me-2"></i>–°–ª–µ–¥—É—é—â–µ–µ —Å–ª–æ–≤–æ
                        </button>
                        <button id="finish-btn" class="btn btn-success btn-lg d-none">
                            <i class="bi bi-check-circle-fill me-2"></i>–ó–∞–≤–µ—Ä—à–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –°–∫—Ä—ã—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ -->
    <input type="hidden" id="exercise-id" value="{{ exercise.id }}">
    <input type="hidden" id="current-index" value="0">

    <script>
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é pairs –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        let pairs = {{ pairs|safe }};
        let currentIndex = 0;
        let totalWords = pairs.length;
        let showHint = false;  // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–¥—Å–∫–∞–∑–∫–∞ —Å–∫—Ä—ã—Ç–∞
        let startTime;  // –î–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è response_time

        // –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–π
        let successAnimationInterval;
        let failureAnimationInterval;
        let successParticlesInterval;
        let failureDropsInterval;

        console.log('Spelling: pairs:', pairs);  // –û—Ç–ª–∞–¥–∫–∞

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function () {
            if (pairs.length === 0) {
                showNoWordsMessage();
                return;
            }

            loadWord(0);
            updateProgress();
            updateWordCounter();
            setupInputNavigation();

            // –ü—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
            if (!document.getElementById('current-russian')) console.error('–≠–ª–µ–º–µ–Ω—Ç current-russian –Ω–µ –Ω–∞–π–¥–µ–Ω');
            if (!document.getElementById('inputs-container')) console.error('–≠–ª–µ–º–µ–Ω—Ç inputs-container –Ω–µ –Ω–∞–π–¥–µ–Ω');
            if (!document.getElementById('check-btn')) console.error('–≠–ª–µ–º–µ–Ω—Ç check-btn –Ω–µ –Ω–∞–π–¥–µ–Ω');
        });

        function showNoWordsMessage() {
            const container = document.getElementById('word-container');
            if (container) {
                container.innerHTML = `
            <div class="text-center py-5">
                <i class="bi bi-exclamation-triangle display-1 text-warning mb-3"></i>
                <h3>–ù–µ—Ç —Å–ª–æ–≤ –¥–ª—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</h3>
                <p class="text-muted">–í —ç—Ç–æ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–∏ –Ω–µ—Ç —Å–ª–æ–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.</p>
                <a href="{% url 'exercises:my_exercises' %}" class="btn btn-primary mt-3">
                    –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
                </a>
            </div>
        `;
            }
        }

        function loadWord(index) {
            if (index >= pairs.length) {
                finishExercise();
                return;
            }

            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–æ–≤–æ–≥–æ —Å–ª–æ–≤–∞
            stopAllAnimations();

            const word = pairs[index];
            const russianElement = document.getElementById('current-russian');
            if (russianElement) russianElement.textContent = word.russian.toUpperCase();

            // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            const inputsContainer = document.getElementById('inputs-container');
            if (inputsContainer) inputsContainer.innerHTML = '';
            const hintElement = document.getElementById('word-hint');
            if (hintElement) hintElement.innerHTML = '';

            // –°–æ–∑–¥–∞–µ–º –ø–æ–ª—è –¥–ª—è –≤–≤–æ–¥–∞ –±—É–∫–≤
            const englishWord = word.english.toUpperCase();
            for (let i = 0; i < englishWord.length; i++) {
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'letter-input';
                input.id = `letter-${i}`;
                input.dataset.index = i;
                input.dataset.expected = englishWord[i];
                input.maxLength = 1;
                input.autocomplete = 'off';
                input.autocapitalize = 'characters';

                if (inputsContainer) inputsContainer.appendChild(input);
            }

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ —Å–ª–æ–≤–∞
            showHint = false;
            updateWordHint();

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–¥—Å–∫–∞–∑–∫–∏ –≤ –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            resetHintButton();

            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
            const checkBtn = document.getElementById('check-btn');
            if (checkBtn) checkBtn.classList.remove('d-none');
            const resetBtn = document.getElementById('reset-btn');
            if (resetBtn) resetBtn.classList.remove('d-none');
            const hintBtn = document.getElementById('show-hint-btn');
            if (hintBtn) hintBtn.classList.remove('d-none');
            const nextBtn = document.getElementById('next-btn');
            if (nextBtn) nextBtn.classList.add('d-none');
            const finishBtn = document.getElementById('finish-btn');
            if (finishBtn) finishBtn.classList.add('d-none');
            const resultMsg = document.getElementById('result-message');
            if (resultMsg) resultMsg.classList.add('d-none');

            // –£–¥–∞–ª—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç—ã –∞–Ω–∏–º–∞—Ü–∏–π –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
            document.querySelectorAll('.success-effect, .failure-effect, .confetti, .sad-face').forEach(el => el.remove());

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ–Ω
            document.body.classList.remove('success-animation', 'failure-animation');

            // –§–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤—ã–π input
            setTimeout(() => {
                const firstInput = document.getElementById('letter-0');
                if (firstInput) firstInput.focus();
            }, 100);

            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –¥–ª—è response_time
            startTime = performance.now();
        }

        function updateWordHint() {
            const word = pairs[currentIndex];
            const englishWord = word.english.toUpperCase();
            const hintElement = document.getElementById('word-hint');

            if (hintElement) {
                if (showHint) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é –∏ –ø–æ—Å–ª–µ–¥–Ω—é—é –±—É–∫–≤—É
                    let hint = '';
                    for (let i = 0; i < englishWord.length; i++) {
                        if (i === 0 || i === englishWord.length - 1) {
                            hint += englishWord[i] + ' ';
                        } else {
                            hint += '_ ';
                        }
                    }
                    hintElement.textContent = hint.trim();
                } else {
                    // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∏—á–µ–≥–æ - –≤—Å–µ –±—É–∫–≤—ã —Å–∫—Ä—ã—Ç—ã
                    let hint = '';
                    for (let i = 0; i < englishWord.length; i++) {
                        hint += '_ ';
                    }
                    hintElement.textContent = hint.trim();
                }
            }
        }

        function setupInputNavigation() {
            const inputsContainer = document.getElementById('inputs-container');
            if (!inputsContainer) return;

            inputsContainer.addEventListener('input', function (e) {
                if (e.target.type === 'text' && e.target.value.length === 1) {
                    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –ø–æ–ª—é
                    const currentIndex = parseInt(e.target.dataset.index);
                    const nextInput = document.getElementById(`letter-${currentIndex + 1}`);
                    if (nextInput) {
                        nextInput.focus();
                    }
                }
            });

            inputsContainer.addEventListener('keydown', function (e) {
                const input = e.target;
                const currentIndex = parseInt(input.dataset.index);

                if (e.key === 'Backspace' && input.value === '') {
                    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –ø–æ–ª—é
                    const prevInput = document.getElementById(`letter-${currentIndex - 1}`);
                    if (prevInput) {
                        prevInput.focus();
                    }
                } else if (e.key === 'ArrowLeft') {
                    const prevInput = document.getElementById(`letter-${currentIndex - 1}`);
                    if (prevInput) {
                        prevInput.focus();
                    }
                    e.preventDefault();
                } else if (e.key === 'ArrowRight') {
                    const nextInput = document.getElementById(`letter-${currentIndex + 1}`);
                    if (nextInput) {
                        nextInput.focus();
                    }
                    e.preventDefault();
                } else if (e.key === 'Enter') {
                    checkWord();
                    e.preventDefault();
                }
            });
        }

        function checkWord() {
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∞–Ω–∏–º–∞—Ü–∏–∏
            stopAllAnimations();

            const word = pairs[currentIndex];
            const englishWord = word.english.toUpperCase();
            const inputs = document.querySelectorAll('.letter-input');

            let allCorrect = true;
            let userWord = '';

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é –±—É–∫–≤—É
            inputs.forEach((input, index) => {
                const userLetter = input.value.toUpperCase();
                userWord += userLetter;

                if (userLetter === englishWord[index]) {
                    input.classList.remove('incorrect', 'shake');
                    input.classList.add('correct');
                } else {
                    input.classList.remove('correct');
                    input.classList.add('incorrect', 'shake');
                    allCorrect = false;
                }
            });

            // –£–±–∏—Ä–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é —Ç—Ä—è—Å–∫–∏
            setTimeout(() => {
                document.querySelectorAll('.shake').forEach(el => el.classList.remove('shake'));
            }, 300);

            // –í—ã—á–∏—Å–ª—è–µ–º response_time
            const endTime = performance.now();
            const responseTime = (endTime - startTime) / 1000;

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º AJAX –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            fetch("{% url 'exercises:update_word_stat' exercise.id %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({
                    word_id: word.word_id,
                    is_correct: allCorrect,
                    response_time: responseTime
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', data.error);
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error);
                });

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            const resultMessage = document.getElementById('result-message');
            if (allCorrect) {
                resultMessage.className = 'alert alert-success';
                resultMessage.innerHTML = `
            <i class="bi bi-check-circle-fill me-2"></i>
            <strong>–û—Ç–ª–∏—á–Ω–æ!</strong> –°–ª–æ–≤–æ "${englishWord}" –≤–≤–µ–¥–µ–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ!
        `;

                // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é —É—Å–ø–µ—Ö–∞
                startSuccessAnimation();

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–ª–æ–≤–∞
                document.getElementById('check-btn').classList.add('d-none');
                document.getElementById('reset-btn').classList.add('d-none');
                document.getElementById('show-hint-btn').classList.add('d-none');
                document.getElementById('next-btn').classList.remove('d-none');
            } else {
                resultMessage.className = 'alert alert-danger';
                resultMessage.innerHTML = `
            <i class="bi bi-x-circle-fill me-2"></i>
            <strong>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑!</strong> –°–ª–æ–≤–æ –Ω–∞–ø–∏—Å–∞–Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ.
        `;

                // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –Ω–µ—É–¥–∞—á–∏
                startFailureAnimation();
            }

            resultMessage.classList.remove('d-none');
        }

        function resetWord() {
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏
            stopAllAnimations();

            const inputs = document.querySelectorAll('.letter-input');
            inputs.forEach(input => {
                input.value = '';
                input.classList.remove('correct', 'incorrect', 'shake');
            });

            // –£–¥–∞–ª—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç—ã –∞–Ω–∏–º–∞—Ü–∏–π
            document.querySelectorAll('.success-effect, .failure-effect, .confetti, .sad-face').forEach(el => el.remove());

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ–Ω
            document.body.classList.remove('success-animation', 'failure-animation');

            document.getElementById('result-message').classList.add('d-none');
            const firstInput = document.getElementById('letter-0');
            if (firstInput) firstInput.focus();
        }

        function nextWord() {
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏
            stopAllAnimations();

            currentIndex++;
            showHint = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
            loadWord(currentIndex);
            updateProgress();
            updateWordCounter();
        }

        function finishExercise() {
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∞–Ω–∏–º–∞—Ü–∏–∏
            stopAllAnimations();

            const container = document.getElementById('word-container');
            container.innerHTML = `
        <div class="text-center py-5">
            <i class="bi bi-check-circle-fill display-1 text-success mb-3"></i>
            <h3>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!</h3>
            <p class="text-muted">–í—ã —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–∏–ª–∏ –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è.</p>
            <div class="row mt-4">
                <div class="col-md-6 offset-md-3">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h5>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h5>
                            <p>–í—ã–ø–æ–ª–Ω–µ–Ω–æ —Å–ª–æ–≤: <strong>${totalWords}</strong></p>
                            <p>–ü–æ–ø—ã—Ç–æ–∫: <strong>${currentIndex}</strong></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-4">
                <a href="{% url 'exercises:my_exercises' %}" class="btn btn-primary me-2">
                    <i class="bi bi-list me-2"></i>–ö —Å–ø–∏—Å–∫—É —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
                </a>
                <a href="{% url 'dashboard:student' %}" class="btn btn-outline-primary">
                    <i class="bi bi-house me-2"></i>–í –∫–∞–±–∏–Ω–µ—Ç
                </a>
            </div>
        </div>
    `;

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
            completeExercise();
        }

        function updateExerciseProgress(isCorrect) {
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–¥, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        }

        function completeExercise() {
            const exerciseId = document.getElementById('exercise-id').value;

            fetch(`/exercises/complete/${exerciseId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({status: 'completed'})
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ');
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è:', error);
                });
        }

        function updateProgress() {
            if (totalWords === 0) return;
            const progress = ((currentIndex) / totalWords) * 100;
            const progressBar = document.getElementById('exercise-progress');
            if (progressBar) progressBar.style.width = progress + '%';
        }

        function updateWordCounter() {
            const currentWordBadge = document.getElementById('current-word');
            if (currentWordBadge) currentWordBadge.textContent = currentIndex + 1;
            const totalWordsBadge = document.getElementById('total-words');
            if (totalWordsBadge) totalWordsBadge.textContent = totalWords;
        }

        // –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ –∫–Ω–æ–ø–∫–∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏
        function resetHintButton() {
            const showHintBtn = document.getElementById('show-hint-btn');
            if (showHintBtn) {
                showHintBtn.classList.remove('btn-warning');
                showHintBtn.classList.add('btn-info');
                showHintBtn.innerHTML = '<i class="bi bi-lightbulb me-2"></i>–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É';
            }
        }

        // ============= –ê–ù–ò–ú–ê–¶–ò–ò =============

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—Å–µ—Ö –∞–Ω–∏–º–∞—Ü–∏–π
        function stopAllAnimations() {
            if (successAnimationInterval) {
                clearInterval(successAnimationInterval);
                successAnimationInterval = null;
            }
            if (failureAnimationInterval) {
                clearInterval(failureAnimationInterval);
                failureAnimationInterval = null;
            }
            if (successParticlesInterval) {
                clearInterval(successParticlesInterval);
                successParticlesInterval = null;
            }
            if (failureDropsInterval) {
                clearInterval(failureDropsInterval);
                failureDropsInterval = null;
            }

            // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å—ã –∞–Ω–∏–º–∞—Ü–∏–π
            document.body.classList.remove('success-animation', 'failure-animation');

            // –£–¥–∞–ª—è–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
            document.querySelectorAll('.success-effect, .failure-effect, .confetti, .sad-face, .particle').forEach(el => {
                if (el.parentNode) {
                    el.parentNode.removeChild(el);
                }
            });
        }

        // –ê–Ω–∏–º–∞—Ü–∏—è —É—Å–ø–µ—Ö–∞ (—Ñ–µ–π–µ—Ä–≤–µ—Ä–∫)
        function startSuccessAnimation() {
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è —Ñ–æ–Ω–∞
            document.body.classList.add('success-animation');

            // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–æ–Ω—Ñ–µ—Ç—Ç–∏
            const container = document.createElement('div');
            container.className = 'success-effect';
            container.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 9998;
        overflow: hidden;
    `;
            document.body.appendChild(container);

            // –°–æ–∑–¥–∞–µ–º —Ñ–µ–π–µ—Ä–≤–µ—Ä–∫ (–±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π)
            successAnimationInterval = setInterval(() => {
                createConfetti(container);
            }, 150); // –ù–µ–º–Ω–æ–≥–æ —Ä–µ–∂–µ, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å

            // –°–æ–∑–¥–∞–µ–º —á–∞—Å—Ç–∏—Ü—ã —É—Å–ø–µ—Ö–∞ –≤–æ–∫—Ä—É–≥ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ (–±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ)
            successParticlesInterval = setInterval(() => {
                const inputs = document.querySelectorAll('.letter-input.correct');
                inputs.forEach(input => {
                    createSuccessParticle(input);
                });
            }, 500);
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –∫–æ–Ω—Ñ–µ—Ç—Ç–∏
        function createConfetti(container) {
            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ff8800', '#88ff00'];
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.cssText = `
        position: absolute;
        width: 10px;
        height: 10px;
        background-color: ${colors[Math.floor(Math.random() * colors.length)]};
        top: -20px;
        left: ${Math.random() * 100}%;
        border-radius: ${Math.random() > 0.5 ? '50%' : '0'};
        transform: rotate(${Math.random() * 360}deg);
        animation: confetti-fall ${2 + Math.random() * 2}s linear forwards;
        z-index: 9999;
    `;

            container.appendChild(confetti);

            // –£–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
            setTimeout(() => {
                if (confetti.parentNode) {
                    confetti.parentNode.removeChild(confetti);
                }
            }, 4000);
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —á–∞—Å—Ç–∏—Ü —É—Å–ø–µ—Ö–∞ –≤–æ–∫—Ä—É–≥ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –±—É–∫–≤
        function createSuccessParticle(inputElement) {
            const rect = inputElement.getBoundingClientRect();
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.cssText = `
        position: fixed;
        width: 6px;
        height: 6px;
        background-color: #4CAF50;
        border-radius: 50%;
        top: ${rect.top + rect.height / 2}px;
        left: ${rect.left + rect.width / 2}px;
        pointer-events: none;
        z-index: 9999;
        animation: success-particle 1.5s ease-out forwards;
        --tx: ${Math.random() * 100 - 50}px;
        --ty: ${Math.random() * 100 - 50}px;
    `;

            document.body.appendChild(particle);

            // –£–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
            setTimeout(() => {
                if (particle.parentNode) {
                    particle.parentNode.removeChild(particle);
                }
            }, 1500);
        }

        // –ê–Ω–∏–º–∞—Ü–∏—è –Ω–µ—É–¥–∞—á–∏ (–≥—Ä—É—Å—Ç–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç)
        function startFailureAnimation() {
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è —Ñ–æ–Ω–∞
            document.body.classList.add('failure-animation');

            // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –Ω–µ—É–¥–∞—á–∏
            const container = document.createElement('div');
            container.className = 'failure-effect';
            container.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 9998;
        overflow: hidden;
    `;
            document.body.appendChild(container);

            // –°–æ–∑–¥–∞–µ–º –≥—Ä—É—Å—Ç–Ω—ã–µ —Å–º–∞–π–ª–∏–∫–∏ (–±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ)
            failureAnimationInterval = setInterval(() => {
                createSadFace(container);
            }, 800); // –ö–∞–∂–¥—ã–µ 800 –º—Å –Ω–æ–≤—ã–π —Å–º–∞–π–ª–∏–∫

            // –°–æ–∑–¥–∞–µ–º –∫–∞–ø–ª–∏ "–¥–æ–∂–¥—è" –≤–æ–∫—Ä—É–≥ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ (–±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ)
            failureDropsInterval = setInterval(() => {
                const inputs = document.querySelectorAll('.letter-input.incorrect');
                inputs.forEach(input => {
                    createFailureDrop(input);
                });
            }, 600);
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É—Å—Ç–Ω–æ–≥–æ —Å–º–∞–π–ª–∏–∫–∞
        function createSadFace(container) {
            const sadFace = document.createElement('div');
            sadFace.className = 'sad-face';
            sadFace.innerHTML = 'üò¢';
            sadFace.style.cssText = `
        position: absolute;
        font-size: 2rem;
        top: -40px;
        left: ${Math.random() * 100}%;
        animation: sad-fall ${3 + Math.random() * 2}s ease-in forwards;
        z-index: 9999;
    `;

            container.appendChild(sadFace);

            // –£–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
            setTimeout(() => {
                if (sadFace.parentNode) {
                    sadFace.parentNode.removeChild(sadFace);
                }
            }, 5000);
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞–ø–ª–∏ –Ω–µ—É–¥–∞—á–∏ –≤–æ–∫—Ä—É–≥ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –±—É–∫–≤
        function createFailureDrop(inputElement) {
            const rect = inputElement.getBoundingClientRect();
            const drop = document.createElement('div');
            drop.className = 'particle';
            drop.style.cssText = `
        position: fixed;
        width: 4px;
        height: 4px;
        background-color: #ff4444;
        border-radius: 50%;
        top: ${rect.top}px;
        left: ${rect.left + rect.width / 2}px;
        pointer-events: none;
        z-index: 9999;
        animation: failure-drop 2s ease-out forwards;
    `;

            document.body.appendChild(drop);

            // –£–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
            setTimeout(() => {
                if (drop.parentNode) {
                    drop.parentNode.removeChild(drop);
                }
            }, 2000);
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
        const checkBtn = document.getElementById('check-btn');
        if (checkBtn) checkBtn.addEventListener('click', checkWord);
        const resetBtn = document.getElementById('reset-btn');
        if (resetBtn) resetBtn.addEventListener('click', resetWord);
        const nextBtn = document.getElementById('next-btn');
        if (nextBtn) nextBtn.addEventListener('click', nextWord);
        const showHintBtn = document.getElementById('show-hint-btn');
        if (showHintBtn) showHintBtn.addEventListener('click', function () {
            showHint = !showHint;
            updateWordHint();

            if (showHint) {
                this.classList.remove('btn-info');
                this.classList.add('btn-warning');
                this.innerHTML = '<i class="bi bi-eye-slash me-2"></i>–°–∫—Ä—ã—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É';
            } else {
                this.classList.remove('btn-warning');
                this.classList.add('btn-info');
                this.innerHTML = '<i class="bi bi-lightbulb me-2"></i>–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É';
            }
        });
    </script>
{% endblock %}