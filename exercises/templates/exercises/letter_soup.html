{% extends 'base.html' %}
{% block title %}Буквенный суп (Letter Soup){% endblock %}

{% block extra_style %}
<style>
    /* Стили для сетки букв */
    .letter-grid {
        display: inline-grid;
        grid-template-columns: repeat({{ grid_size }}, 35px);
        grid-gap: 2px;
        margin: 20px 0;
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 8px;
        border: 2px solid #dee2e6;
    }
    
    .letter-cell {
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        font-weight: bold;
        background-color: white;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        text-transform: uppercase;
        transition: all 0.2s;
        user-select: none;
    }
    
    .letter-cell:hover {
        background-color: #f1f3f4;
        transform: scale(1.05);
    }
    
    .letter-cell.found {
        background-color: #d1e7dd;
        border-color: #198754;
        color: #0f5132;
    }
    
    /* Стили для списка слов */
    .word-list-item {
        padding: 8px 12px;
        margin: 5px;
        border-radius: 6px;
        background-color: white;
        border: 1px solid #dee2e6;
        transition: all 0.3s;
    }
    
    .word-list-item.found {
        background-color: #d1e7dd;
        border-color: #198754;
        text-decoration: line-through;
        color: #0f5132;
    }
    
    /* Счетчик */
    .counter-badge {
        font-size: 1.2rem;
        padding: 8px 16px;
    }
    
    /* Анимации */
    @keyframes foundAnimation {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }
    
    .found-animation {
        animation: foundAnimation 0.5s ease;
    }

    /* Заголовок упражнения */
    .exercise-title {
        font-size: 1.8rem;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 0.5rem;
    }

    .exercise-subtitle {
        color: #6c757d;
        font-size: 1.1rem;
        margin-bottom: 1.5rem;
    }

    /* Инструкция */
    .instruction {
        background-color: #f8f9fa;
        border-left: 4px solid #0d6efd;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }

    /* Прогресс */
    .progress-container {
        position: sticky;
        top: 0;
        background: white;
        z-index: 100;
        padding: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Заголовок упражнения -->
    <div class="row mb-4">
        <div class="col">
            <div class="exercise-title">
                {% if exercise.description %}
                    {{ exercise.description }}
                {% else %}
                    Буквенный суп (Letter Soup)
                {% endif %}
            </div>
            <div class="exercise-subtitle">
                Найдите английские слова в буквенной сетке
                {% if exercise.due_date %}
                    <span class="badge bg-warning ms-2">
                        Срок: {{ exercise.due_date|date:"d.m.Y H:i" }}
                    </span>
                {% endif %}
            </div>
        </div>
        <div class="col-auto">
            <div class="badge bg-primary fs-6">
                {{ exercise.get_assignment_type_display }}
            </div>
        </div>
    </div>

    <!-- Прогресс -->
    <div class="progress-container mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <h4 class="mb-0">Буквенный суп (Letter Soup)</h4>
            <div>
                <span id="current-word" class="badge bg-primary fs-6">0</span> из
                <span id="total-words" class="badge bg-secondary fs-6">{{ pairs|length }}</span>
            </div>
        </div>
        <div class="progress mt-2" style="height: 8px;">
            <div id="exercise-progress" class="progress-bar" style="width: 0%"></div>
        </div>
    </div>

    <!-- Инструкция -->
    <div class="instruction mb-4">
        <h6><i class="bi bi-info-circle me-2"></i>Как играть:</h6>
        <p class="mb-0">
            1. Посмотрите на список слов справа<br>
            2. Найдите эти слова в буквенной сетке<br>
            3. Введите найденное слово в поле ниже<br>
            4. Слова могут располагаться по горизонтали (→) или вертикали (↓)
        </p>
    </div>

    <!-- Основное содержимое -->
    <div class="row">
        <!-- Левая колонка: сетка букв -->
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-grid-3x3-gap me-2"></i>
                        Сетка букв ({{ grid_size }}×{{ grid_size }})
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center">
                        <div class="letter-grid" id="letter-grid">
                            {% for row in grid %}
                                {% for cell in row %}
                                    <div class="letter-cell"
                                         data-row="{{ forloop.parentloop.counter0 }}"
                                         data-col="{{ forloop.counter0 }}">
                                        {{ cell }}
                                    </div>
                                {% endfor %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Правая колонка: список слов и ввод -->
        <div class="col-lg-4">
            <!-- Список слов для поиска -->
            <div class="card shadow mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-list-ul me-2"></i>
                        Слова для поиска
                        <span class="badge bg-light text-dark ms-2">{{ pairs|length }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-2" id="word-list">
                        {% for pair in pairs %}
                            <div class="col-md-6">
                                <div class="word-list-item"
                                     id="word-{{ pair.english|lower }}"
                                     data-english="{{ pair.english|lower }}">
                                    <div class="fw-bold">{{ pair.russian }}</div>
                                    <div class="text-primary small">{{ pair.english|upper }}</div>
                                    <small class="text-muted">{{ pair.english|length }} букв</small>
                                </div>
                            </div>
                        {% empty %}
                            <div class="col-12 text-center">
                                <p class="text-muted">Нет слов для поиска</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Ввод слова -->
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-keyboard me-2"></i>
                        Ввод найденного слова
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Введите английское слово:</label>
                        <input type="text"
                               class="form-control form-control-lg text-uppercase"
                               id="word-input"
                               placeholder="APPLE"
                               autocomplete="off"
                               autofocus>
                        <div class="form-text">
                            Введите слово в любом регистре
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button class="btn btn-primary btn-lg" id="check-word-btn">
                            <i class="bi bi-check-circle me-2"></i>Проверить
                        </button>
                        <button class="btn btn-outline-secondary" id="hint-btn">
                            <i class="bi bi-lightbulb me-2"></i>Показать подсказку
                        </button>
                        <button class="btn btn-outline-danger" id="skip-btn">
                            <i class="bi bi-skip-forward me-2"></i>Пропустить слово
                        </button>
                    </div>

                    <!-- Сообщения -->
                    <div id="message-container" class="mt-3"></div>

                    <!-- Статистика -->
                    <div class="mt-4 pt-3 border-top">
                        <h6>Статистика:</h6>
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="h4 mb-0" id="found-count">0</div>
                                <small>Найдено</small>
                            </div>
                            <div class="col-4">
                                <div class="h4 mb-0" id="remaining-count">{{ pairs|length }}</div>
                                <small>Осталось</small>
                            </div>
                            <div class="col-4">
                                <div class="h4 mb-0" id="hint-count">0</div>
                                <small>Подсказок</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Скрытые данные -->
<input type="hidden" id="exercise-id" value="{{ exercise.id }}">
<input type="hidden" id="grid-size" value="{{ grid_size }}">

<script>
// Глобальные переменные
let pairs = {{ pairs|safe }};
let englishWords = [];
let foundWords = new Set();
let totalWords = pairs.length;
let gridData = {{ grid|safe }};
let placedWords = {{ placed_words|safe }};
let gridSize = {{ grid_size }};
let hintCount = 0;

// Извлекаем английские слова из пар
pairs.forEach(pair => {
    englishWords.push(pair.english.toLowerCase());
});

console.log('Letter Soup: pairs:', pairs);  // Отладка
console.log('English words:', englishWords);  // Отладка
console.log('Placed words:', placedWords);  // Отладка
console.log('Grid size:', gridSize);  // Отладка

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    if (totalWords === 0) {
        showNoWordsMessage();
        return;
    }

    updateCounters();
    updateProgress();

    // Обработчики событий
    document.getElementById('check-word-btn').addEventListener('click', checkWord);
    document.getElementById('hint-btn').addEventListener('click', showHint);
    document.getElementById('skip-btn').addEventListener('click', skipWord);

    document.getElementById('word-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            checkWord();
        }
    });

    // Автоматический фокус на поле ввода
    setTimeout(() => {
        document.getElementById('word-input').focus();
    }, 100);
});

function showNoWordsMessage() {
    const container = document.querySelector('.container');
    container.innerHTML = `
        <div class="text-center py-5">
            <i class="bi bi-exclamation-triangle display-1 text-warning mb-3"></i>
            <h3>Нет слов для упражнения</h3>
            <p class="text-muted">В этом упражнении нет слов для поиска.</p>
            <a href="{% url 'exercises:my_exercises' %}" class="btn btn-primary mt-3">
                Вернуться к списку упражнений
            </a>
        </div>
    `;
}

function checkWord() {
    const wordInput = document.getElementById('word-input');
    const word = wordInput.value.trim().toLowerCase();

    if (!word) {
        showMessage('Введите слово', 'warning');
        return;
    }

    if (word.length < 2) {
        showMessage('Слово должно содержать минимум 2 буквы', 'warning');
        return;
    }

    // Проверяем, есть ли такое слово в списке
    if (englishWords.includes(word)) {
        // Проверяем, не было ли слово уже найдено
        if (foundWords.has(word)) {
            showMessage(`Слово "${word.toUpperCase()}" уже было найдено`, 'warning');
            wordInput.value = '';
            wordInput.focus();
            return;
        }

        // Проверяем, есть ли слово в сетке
        if (isWordInGrid(word)) {
            // Добавляем слово в найденные
            foundWords.add(word);

            // Обновляем интерфейс
            markWordAsFound(word);
            highlightWordInGrid(word);
            updateCounters();
            updateProgress();

            // Показываем успешное сообщение
            showMessage(`Отлично! Слово "${word.toUpperCase()}" найдено!`, 'success');

            // Проверяем, все ли слова найдены
            if (foundWords.size === totalWords) {
                finishExercise();
            }
        } else {
            showMessage(`Слово "${word.toUpperCase()}" есть в списке, но не найдено в сетке. Попробуйте другое слово.`, 'danger');
        }
    } else {
        showMessage(`Слово "${word.toUpperCase()}" не найдено в списке слов`, 'danger');
    }

    // Очищаем поле ввода
    wordInput.value = '';
    wordInput.focus();
}

function isWordInGrid(word) {
    const wordUpper = word.toUpperCase();

    // Проверяем по размещенным словам
    for (const placedWord of placedWords) {
        if (placedWord.word === wordUpper) {
            return true;
        }
    }

    // Также проверяем вручную (на случай ошибок в алгоритме размещения)
    return checkWordInGridManually(wordUpper);
}

function checkWordInGridManually(word) {
    // Проверяем горизонтально
    for (let row = 0; row < gridSize; row++) {
        for (let col = 0; col <= gridSize - word.length; col++) {
            let found = true;
            for (let i = 0; i < word.length; i++) {
                if (gridData[row][col + i] !== word[i]) {
                    found = false;
                    break;
                }
            }
            if (found) return true;
        }
    }

    // Проверяем вертикально
    for (let row = 0; row <= gridSize - word.length; row++) {
        for (let col = 0; col < gridSize; col++) {
            let found = true;
            for (let i = 0; i < word.length; i++) {
                if (gridData[row + i][col] !== word[i]) {
                    found = false;
                    break;
                }
            }
            if (found) return true;
        }
    }

    return false;
}

function highlightWordInGrid(word) {
    const wordUpper = word.toUpperCase();

    // Ищем слово в размещенных словах
    for (const placedWord of placedWords) {
        if (placedWord.word === wordUpper) {
            const { row, col, direction, length } = placedWord;

            // Подсвечиваем ячейки
            for (let i = 0; i < length; i++) {
                let cellRow = row;
                let cellCol = col;

                if (direction === 'horizontal') {
                    cellCol = col + i;
                } else { // vertical
                    cellRow = row + i;
                }

                const cell = document.querySelector(`.letter-cell[data-row="${cellRow}"][data-col="${cellCol}"]`);
                if (cell) {
                    cell.classList.add('found', 'found-animation');
                    setTimeout(() => {
                        cell.classList.remove('found-animation');
                    }, 500);
                }
            }
            return;
        }
    }
}

function markWordAsFound(word) {
    const wordElement = document.getElementById(`word-${word}`);
    if (wordElement) {
        wordElement.classList.add('found');
    }
}

function showHint() {
    // Находим первое не найденное слово
    const remainingWords = englishWords.filter(word => !foundWords.has(word));

    if (remainingWords.length === 0) {
        showMessage('Все слова уже найдены!', 'info');
        return;
    }

    const randomWord = remainingWords[Math.floor(Math.random() * remainingWords.length)];
    const wordElement = document.getElementById(`word-${randomWord}`);

    if (wordElement) {
        // Мигаем элементом слова
        wordElement.classList.add('found-animation');
        setTimeout(() => {
            wordElement.classList.remove('found-animation');
        }, 1000);

        // Обновляем счетчик подсказок
        hintCount++;
        document.getElementById('hint-count').textContent = hintCount;

        showMessage(`Подсказка: слово "${randomWord.toUpperCase()}" еще не найдено`, 'info');
    }
}

function skipWord() {
    // Находим первое не найденное слово
    const remainingWords = englishWords.filter(word => !foundWords.has(word));

    if (remainingWords.length === 0) {
        showMessage('Все слова уже найдены!', 'info');
        return;
    }

    const randomWord = remainingWords[Math.floor(Math.random() * remainingWords.length)];
    document.getElementById('word-input').value = randomWord.toUpperCase();
    document.getElementById('word-input').focus();

    showMessage(`Попробуйте найти слово "${randomWord.toUpperCase()}"`, 'info');
}

function updateCounters() {
    document.getElementById('found-count').textContent = foundWords.size;
    document.getElementById('remaining-count').textContent = totalWords - foundWords.size;
    document.getElementById('current-word').textContent = foundWords.size;
    document.getElementById('total-words').textContent = totalWords;
}

function updateProgress() {
    const progress = (foundWords.size / totalWords) * 100;
    document.getElementById('exercise-progress').style.width = `${progress}%`;
}

function showMessage(text, type) {
    const messageContainer = document.getElementById('message-container');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.innerHTML = `
        ${text}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    messageContainer.innerHTML = '';
    messageContainer.appendChild(alert);

    // Автоматически скрываем через 3 секунды
    setTimeout(() => {
        if (alert.parentNode) {
            alert.classList.remove('show');
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 150);
        }
    }, 3000);
}

function finishExercise() {
    showMessage('Поздравляем! Вы нашли все слова! Упражнение завершено.', 'success');

    // Отключаем элементы управления
    document.getElementById('word-input').disabled = true;
    document.getElementById('check-word-btn').disabled = true;
    document.getElementById('hint-btn').disabled = true;
    document.getElementById('skip-btn').disabled = true;

    // Показываем кнопку завершения
    const controlsDiv = document.querySelector('.d-grid');
    const finishBtn = document.createElement('button');
    finishBtn.className = 'btn btn-success btn-lg mt-3';
    finishBtn.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>Завершить упражнение';
    finishBtn.addEventListener('click', function() {
        completeExerciseOnServer();
    });
    controlsDiv.appendChild(finishBtn);

    // Отправляем запрос на завершение упражнения
    completeExerciseOnServer();
}

function completeExerciseOnServer() {
    const exerciseId = document.getElementById('exercise-id').value;

    fetch(`/exercises/complete/${exerciseId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            status: 'completed',
            found_words: Array.from(foundWords),
            hint_count: hintCount
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Упражнение завершено на сервере');
            // Перенаправляем на страницу с результатами или на список упражнений
            window.location.href = "{% url 'exercises:my_exercises' %}";
        }
    })
    .catch(error => {
        console.error('Ошибка при завершении упражнения:', error);
    });
}
</script>
{% endblock %}